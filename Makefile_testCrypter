## #############################################################
## Makefile for Crypter test suite
## 
##   make check   : run a set of tests on dynamically allocated keys
##		    store errors in tmp.NNN directories
## 
## Required script files:
##   check_random_message
## 
## Synopsis:
##  testing KeyGeneratort / Crypter / CryptoModule
##  by generating random messages, 
##    encrypting, decrypting, and check for identity
## -------------------------------------------------------------
## @TABLE OF CONTENTS:		       [TOCD: 11:04 20 Nov 2004]
##
##      [0.1] TEST SETUP
##  [1] MAIN TARGET: check
##  [2] BACKUP THE LAST FAIL
## #############################################################
## @FILE:    Makefile
## @PLACE:   Mars Workstation
## @FORMAT:  plain text
## @AUTHOR:  M. Oliver M'o'ller     <omoeller@verify-it.de>
## @BEGUN:   Sat Nov 20 10:56:01 2004
## @VERSION: Sat Nov 20 10:56:01 2004
## #############################################################


## ###############################################
## [0.1] TEST SETUP
## ###############################################

# N = 16 does not work properly on all file/encoding systems
N_TO_TEST= 7 8  
KEY_LENGTHS_TO_TEST=13 20 50 70 100 200 300 400 500 800 1000 2000
MESSAGE_LENGTHS_TO_TEST=1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 \
	200 500 1000 2000

## ###############################################
## MAKE SETUPS
## ###############################################

SHELL=bash

## ###################################################################
## [1] MAIN TARGET: check
## ###################################################################

.PHONEY: check 

check:
	@if [ ! -d tmp.000 ]; then mkdir tmp.000 ; fi ;
	@touch CryptoModule.java ;
	rm -f *.class ;
	javac KeyGeneratorCS.java ;
	@for k in $(KEY_LENGTHS_TO_TEST); do \
	    rm CryptoModule.java ; \
            java KeyGeneratorCS -n TestKey-$$k -o Test -f CryptoModule.java $$k; \
	    javac -classpath . Crypter.java; \
	    for m in $(MESSAGE_LENGTHS_TO_TEST); do \
		for n in $(N_TO_TEST); do \
		echo "** TESTING (MESSAGE_LENGTH, KEY_LENGTH, N) = ($$m, $$k, $$n)"; \
		if ! bash -x check_random_message $$m  $$n 2>/dev/null; then \
		   echo "ERROR WITH (MESSAGE_LENGTH, KEY_LENGTH, N) = ($$m, $$k, $$n)"; \
		   make save ; \
		   exit 1; \
		fi; \
		done;	\
	    done	\
	done;



## ###################################################################
## [2] BACKUP THE LAST FAIL
## ###################################################################

.PHONEY: save cleansave

save:
	@export NUM=$$(($$(echo "1`ls | grep "tmp[.][0-9][0-9][0-9]" |sort | tail -c 4`")-999)) ; \
	export DIR="tmp.$$(printf "%03d" $${NUM})"; \
	echo "## SAVING IN DIR $${DIR} "; \
	mkdir $${DIR}; \
	cp *.java *.class message.* $${DIR} ; \
	echo "done" ;

cleansave:
	rm -rf tmp.[0-9][0-9][0-9] ;
	mkdir tmp.000 ;


